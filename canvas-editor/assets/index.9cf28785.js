var _=Object.defineProperty;var C=(a,t,i)=>t in a?_(a,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):a[t]=i;var h=(a,t,i)=>(C(a,typeof t!="symbol"?t+"":t,i),i);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))e(o);new MutationObserver(o=>{for(const n of o)if(n.type==="childList")for(const s of n.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&e(s)}).observe(document,{childList:!0,subtree:!0});function i(o){const n={};return o.integrity&&(n.integrity=o.integrity),o.referrerpolicy&&(n.referrerPolicy=o.referrerpolicy),o.crossorigin==="use-credentials"?n.credentials="include":o.crossorigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function e(o){if(o.ep)return;o.ep=!0;const n=i(o);fetch(o.href,n)}})();const d=4;class y{constructor(t,i){h(this,"_container");h(this,"_cursor");h(this,"_data");h(this,"_height");h(this,"_top");h(this,"_left");h(this,"_renderDataPosition");h(this,"_dataPosition");this._container=t,this._cursor=null,this._data=i;const e=this._data.getConfg();this._height=e.lineHeight*e.fontSize+d,this._top=e.pageMargin-d/2+1,this._left=e.pageMargin-e.wordSpace/2-.5,this._dataPosition=-1,this._renderDataPosition=[-1,0],this._createCursor(),this.updateCursor()}_createCursor(){const t=document.createElement("div");t.style.width="1px",t.style.position="absolute",t.style.background="black",t.style.display="none",t.style.userSelect="none",t.classList.add("editor-cursor"),this._cursor=t,this._container.append(t)}hideCursor(){this._cursor.style.display="none"}showCursor(){this._cursor.style.display="block"}updateCursor(){!this._cursor||(this._cursor.style.left=`${this._left}px`,this._cursor.style.top=`${this._top}px`,this._cursor.style.height=`${this._height}px`)}getCursorPosition(t,i,e){const{top:o,textY:n}=this._getTextYCursorPosition(e,i),s=e[n].texts,{left:r,textX:f}=this._getTextXCursorPosition(s,t);return{left:r,textX:f,top:o,textY:n}}setCursorPosition(t,i){const e=this._data.getRenderContent(),{left:o,textX:n,top:s,textY:r}=this.getCursorPosition(t,i,e);this._top=s,this._left=o;let f=0;e.forEach((l,c)=>{c<r&&(f+=l.texts.length)}),this.setDataPosition(f+n)}setCursorPositionByData(){const{top:t,left:i}=this._getLineCursorPositionByData();this._left=i,this._top=t}_getLineCursorPositionByData(){const t=this._data.getConfg();let i=t.pageMargin-d/2+1,e=t.pageMargin-t.wordSpace/2-.5;const o=this._data.getRenderContent();if(o.length>0){for(const[n,s]of o.entries()){if(this._renderDataPosition[0]===n)break;i=i+s.height*t.lineHeight}for(const[n,s]of o[this._renderDataPosition[0]].texts.entries()){if(this._renderDataPosition[1]<n)break;e=e+s.width+t.wordSpace}}return{top:i,left:e}}_getTextYCursorPosition(t,i){const e=this._data.getConfg();let o=e.pageMargin-d/2+1,n=0;const s=t.length;for(const[r,f]of t.entries()){if(i<o+f.height*e.lineHeight)break;r+1<s&&(n++,o=o+f.height*e.lineHeight)}return{top:o,textY:n}}_getTextXCursorPosition(t,i){const e=this._data.getConfg();let o=e.pageMargin-e.wordSpace/2-.5,n=-1;for(const s of t){if(i<o+s.width/2)break;n++,o=o+s.width+e.wordSpace}return{left:o,textX:n}}setCursorHeight(t){const i=this._data.getConfg();this._height=t*i.lineHeight+d}setRenderDataPosition(){if(this._dataPosition===-1)this._renderDataPosition=[0,-1];else{const t=this._data.getRenderContent();let i=0;for(const[e,o]of t.entries())if(this._dataPosition<i+o.texts.length){this._renderDataPosition=[e,this._dataPosition-i];break}else i=i+o.texts.length}}getRenderDataPosition(){return this._renderDataPosition}setDataPosition(t){t<-1||t>=this._data.getLength()||(this._dataPosition=t,this.setRenderDataPosition())}getDataPosition(){return this._dataPosition}}var u=(a=>(a.ENTER="Enter",a.BACKSPACE="Backspace",a.LEFT="ArrowLeft",a.TOP="ArrowUp",a.RIGHT="ArrowRight",a.BOTTOM="ArrowDown",a))(u||{});class S{constructor(t){h(this,"_textarea");h(this,"_container");this._container=t,this._textarea=this._createTextarea()}_createTextarea(){const t=document.createElement("textarea");return t.style.position="absolute",t.style.zIndex="-100",t.style.right="100px",t.style.background="transparent",t.style.border="none",t.style.resize="none",t.style.outline="none",t.style.color="transparent",this._container.append(t),t}getTextareaElement(){return this._textarea}}const m=new RegExp("[\u4E00-\u9FA5]+"),w=new RegExp("[\u300A\u300B~\uFF01@#\uFFE5\u2026\u2026&*\uFF08\uFF09\u2014\u2014|{}\u3010\u3011\u2018\uFF1B\uFF1A\u201D\u201C'\u3002\uFF0C\u3001\uFF1F]"),p=a=>m.test(a)||w.test(a);class x{constructor(t,i){h(this,"_container");h(this,"_canvas");h(this,"_ctx");h(this,"_textarea");h(this,"_data");h(this,"_cursor");h(this,"_selectArea");h(this,"_click");this._container=t,this._selectArea=null,this._click=null;const{canvas:e,ctx:o}=this._createCanvas();this._canvas=e,this._ctx=o,this._data=i,this._data.setPageWidth(this._canvas.width);const n=new S(this._container);this._textarea=n.getTextareaElement(),this._cursor=new y(this._container,this._data),this._bindEvents(),this._renderRichText()}_createCanvas(){const t=window.innerWidth,i=window.innerHeight,e=document.createElement("canvas");e.style.background="#fff";const o=window.devicePixelRatio;e.width=t*o,e.height=i*o;const n=e.getContext("2d");return n.scale(o,o),this._container.append(e),{canvas:e,ctx:n}}_resize(){const t=window.innerWidth,i=window.innerHeight;this._canvas.width=t,this._canvas.height=i}_unbindEvents(){}_bindEvents(){window.addEventListener("resize",this._resize.bind(this)),this._canvas.addEventListener("mousedown",this._onMouseDown.bind(this)),this._canvas.addEventListener("mousemove",this._onMouseMove.bind(this)),this._canvas.addEventListener("mouseup",this._onMouseUp.bind(this)),this._textarea.addEventListener("change",t=>{console.log("==== change",t)}),this._textarea.addEventListener("focus",t=>{console.log("==== focus",t)}),this._textarea.addEventListener("input",t=>this._onInput(t)),this._textarea.addEventListener("compositionstart",t=>this._onCompStart(t)),this._textarea.addEventListener("compositionend",t=>this._onCompEnd(t)),this._textarea.addEventListener("keydown",t=>this._onKeydown(t))}_onMouseDown(t){const i=this._data.getRenderContent(),{textX:e,textY:o}=this._cursor.getCursorPosition(t.clientX,t.clientY,i);this._click={x:t.clientX,y:t.clientY,textX:e+1,textY:o},this._focus(this._click.x,this._click.y),this._selectArea=null,this._renderRichText()}_onMouseMove(t){if(t.preventDefault(),this._click){const i=this._data.getRenderContent(),{textX:e,textY:o}=this._cursor.getCursorPosition(t.clientX,t.clientY,i);let n=this._click.textX,s=this._click.textY,r=e+1,f=o;f<s?(r=this._click.textX,f=this._click.textY,n=e+1,s=o):f===s&&n>r&&(r=this._click.textX,n=e+1),this._selectArea=[n,s,r,f],this._renderRichText()}}_onMouseUp(t){t.preventDefault(),this._click=null}_focus(t,i){this._cursor.setCursorPosition(t,i),this._cursor.updateCursor(),this._cursor.showCursor(),setTimeout(()=>{this._textarea.focus()},100)}_blur(){this._textarea.blur(),this._cursor.hideCursor()}_onInput(t){t.inputType==="insertText"&&t.data&&(console.log("== \u6587\u5B57",t.data),this._inputText(t.data))}_onCompStart(t){console.log("=== \u5F00\u59CB\u8F93\u5165\u4E2D\u6587",t)}_onCompEnd(t){console.log("=== \u7ED3\u675F\u8F93\u5165\u4E2D\u6587",t.data),t.data&&t.data.split("").forEach(e=>{this._inputText(e)})}_onKeydown(t){switch(console.log(t.key),t.key){case u.LEFT:{const i=this._cursor.getDataPosition();this._cursor.setDataPosition(i-1),this._cursor.setCursorPositionByData(),this._cursor.updateCursor();break}case u.RIGHT:{const i=this._cursor.getDataPosition();this._cursor.setDataPosition(i+1),this._cursor.setCursorPositionByData(),this._cursor.updateCursor();break}case u.TOP:{const i=this._cursor.getDataPosition(),e=this._cursor.getRenderDataPosition();if(e[0]>0){const o=this._data.getStashRenderContent(),n=o[e[0]].texts;let s=0;for(const[c,g]of n.entries())c<e[1]&&(s+=g.width);const r=o[e[0]-1].texts;let f=-1,l=0;for(const c of r)if(l<s)f++,l+=c.width;else break;this._cursor.setDataPosition(i-(e[1]+r.length-1-f)),this._cursor.setCursorPositionByData(),this._cursor.updateCursor()}break}case u.BOTTOM:{const i=this._cursor.getDataPosition(),e=this._cursor.getRenderDataPosition(),o=this._data.getStashRenderContent();if(e[0]<o.length-1){const n=o[e[0]].texts;let s=0;for(const[c,g]of n.entries())c<e[1]&&(s+=g.width);const r=o[e[0]+1].texts;let f=-1,l=0;for(const c of r)if(l<=s)f++,l+=c.width;else break;this._cursor.setDataPosition(i+(n.length-e[1]+f)),this._cursor.setCursorPositionByData(),this._cursor.updateCursor()}break}case u.ENTER:{const i=this._data.getConfg(),e={value:`
`,fontSize:i.fontSize,fontFamily:i.fontFamily,fontWeight:i.fontWeight,fontColor:i.fontColor,fontStyle:i.fontStyle,width:0,height:0,isChinese:!1},o=this._cursor.getDataPosition();this._data.addContent(e,o+1),this._cursor.setDataPosition(o+1),this._cursor.setCursorPositionByData(),this._cursor.updateCursor(),this._renderRichText();break}case u.BACKSPACE:{this._deleteText();break}}}_deleteText(t=0){const i=this._cursor.getDataPosition();this._data.deleteContent(i+t)&&(t===0&&(this._cursor.setDataPosition(this._cursor.getDataPosition()-1),this._cursor.setCursorPositionByData(),this._cursor.updateCursor()),this._renderRichText())}_inputText(t){const i=this._data.getConfg(),e={value:t,fontSize:i.fontSize,fontFamily:i.fontFamily,fontWeight:i.fontWeight,fontColor:i.fontColor,fontStyle:i.fontStyle,width:i.fontSize,height:i.fontSize,isChinese:p(t)},{width:o,height:n}=this._getFontSize(e);e.width=o,e.height=n;const s=this._cursor.getDataPosition();this._data.addContent(e,s+1),this._cursor.setDataPosition(s+1),this._cursor.setCursorPositionByData(),this._cursor.updateCursor(),this._renderRichText(),this._textarea.value=""}_getFontSize(t){this._ctx.font=`${t.fontStyle} ${t.fontWeight} ${t.fontSize}px ${t.fontFamily}`;const i=this._ctx.measureText(t.value);console.log(i);const e=i.width,o=i.actualBoundingBoxAscent+i.actualBoundingBoxDescent;return{width:e,height:o}}_clear(){this._ctx.clearRect(0,0,this._canvas.width,this._canvas.height)}_renderRange({x:t,y:i,width:e,height:o}){this._ctx.save(),this._ctx.globalAlpha=.6,this._ctx.fillStyle="#AECBFA",this._ctx.fillRect(t,i,e,o),this._ctx.restore()}_renderRichText(){this._clear();const t=this._data.getRenderContent(),i=this._data.getConfg();let e=i.pageMargin,o=i.pageMargin;t.forEach((n,s)=>{if(this._selectArea){const r=this._data.getRenderSelect(e,o,n,s,this._selectArea);r&&this._renderRange(r)}n.texts.forEach(r=>{r.value!==`
`&&(this._fillText(r,e,o),e=e+r.width+i.wordSpace)}),e=i.pageMargin,o=o+n.height*i.lineHeight})}_fillText(t,i,e){this._ctx.textBaseline="top";const o=this._data.getConfg();this._ctx.font=`${t.fontStyle} ${t.fontWeight} ${t.fontSize}px ${t.fontFamily}`;const n=(o.lineHeight-1)*t.fontSize/2;this._ctx.fillText(t.value,i,e+n,t.fontSize)}}const v=[{value:"c",fontSize:16,width:8.751998901367188,height:8.720000267028809,fontStyle:"normal",fontWeight:"400",fontFamily:"serif",fontColor:"#f60000",isChinese:!1},{value:"a",fontSize:16,width:8.943984985351562,height:8.720000267028809,fontStyle:"normal",fontWeight:"400",fontFamily:"serif",fontColor:"#f60000",isChinese:!1},{value:"n",fontSize:16,width:8.943984985351562,height:8.496000289916992,fontStyle:"normal",fontWeight:"400",fontFamily:"serif",fontColor:"#f60000",isChinese:!1},{value:"a",fontSize:16,width:8.943984985351562,height:8.720000267028809,fontStyle:"normal",fontWeight:"400",fontFamily:"serif",fontColor:"#f60000",isChinese:!1},{value:"s",fontSize:16,width:8.079986572265625,height:8.720000267028809,fontStyle:"normal",fontWeight:"400",fontFamily:"serif",fontColor:"#f60000",isChinese:!1},{value:"\u5BCC",fontSize:16,width:16,height:15.26400089263916,fontStyle:"normal",fontWeight:"400",fontFamily:"serif",fontColor:"#444",isChinese:!0},{value:"\u6587",fontSize:16,width:16,height:14.831999778747559,fontStyle:"normal",fontWeight:"400",fontFamily:"serif",fontColor:"#444",isChinese:!0},{value:"\u672C",fontSize:16,width:16,height:15.37600040435791,fontStyle:"normal",fontWeight:"400",fontFamily:"serif",fontColor:"#444",isChinese:!0},{value:"\u6E32",fontSize:16,width:16,height:14.592000007629395,fontStyle:"normal",fontWeight:"400",fontFamily:"serif",fontColor:"#444",isChinese:!0},{value:"\u67D3",fontSize:16,width:16,height:15.35999870300293,fontStyle:"normal",fontWeight:"400",fontFamily:"serif",fontColor:"#444",isChinese:!0},{value:"c",fontSize:16,width:8.751998901367188,height:8.720000267028809,fontStyle:"normal",fontWeight:"400",fontFamily:"serif",fontColor:"#f60000",isChinese:!1},{value:"a",fontSize:16,width:8.943984985351562,height:8.720000267028809,fontStyle:"normal",fontWeight:"400",fontFamily:"serif",fontColor:"#f60000",isChinese:!1},{value:"n",fontSize:16,width:8.943984985351562,height:8.496000289916992,fontStyle:"normal",fontWeight:"400",fontFamily:"serif",fontColor:"#f60000",isChinese:!1},{value:"a",fontSize:16,width:8.943984985351562,height:8.720000267028809,fontStyle:"normal",fontWeight:"400",fontFamily:"serif",fontColor:"#f60000",isChinese:!1},{value:"s",fontSize:16,width:8.079986572265625,height:8.720000267028809,fontStyle:"normal",fontWeight:"400",fontFamily:"serif",fontColor:"#f60000",isChinese:!1},{value:"\u5BCC",fontSize:16,width:16,height:15.26400089263916,fontStyle:"normal",fontWeight:"400",fontFamily:"serif",fontColor:"#444",isChinese:!0},{value:"\u6587",fontSize:16,width:16,height:14.831999778747559,fontStyle:"normal",fontWeight:"400",fontFamily:"serif",fontColor:"#444",isChinese:!0},{value:"\u672C",fontSize:16,width:16,height:15.37600040435791,fontStyle:"normal",fontWeight:"400",fontFamily:"serif",fontColor:"#444",isChinese:!0},{value:"\u6E32",fontSize:16,width:16,height:14.592000007629395,fontStyle:"normal",fontWeight:"400",fontFamily:"serif",fontColor:"#444",isChinese:!0},{value:"\u67D3",fontSize:16,width:16,height:15.35999870300293,fontStyle:"normal",fontWeight:"400",fontFamily:"serif",fontColor:"#444",isChinese:!0},{value:"c",fontSize:16,width:8.751998901367188,height:8.720000267028809,fontStyle:"normal",fontWeight:"400",fontFamily:"serif",fontColor:"#f60000",isChinese:!1},{value:"a",fontSize:16,width:8.943984985351562,height:8.720000267028809,fontStyle:"normal",fontWeight:"400",fontFamily:"serif",fontColor:"#f60000",isChinese:!1},{value:"n",fontSize:16,width:8.943984985351562,height:8.496000289916992,fontStyle:"normal",fontWeight:"400",fontFamily:"serif",fontColor:"#f60000",isChinese:!1},{value:"a",fontSize:16,width:8.943984985351562,height:8.720000267028809,fontStyle:"normal",fontWeight:"400",fontFamily:"serif",fontColor:"#f60000",isChinese:!1},{value:"s",fontSize:16,width:8.079986572265625,height:8.720000267028809,fontStyle:"normal",fontWeight:"400",fontFamily:"serif",fontColor:"#f60000",isChinese:!1},{value:"\u5BCC",fontSize:16,width:16,height:15.26400089263916,fontStyle:"normal",fontWeight:"400",fontFamily:"serif",fontColor:"#444",isChinese:!0},{value:"\u6587",fontSize:16,width:16,height:14.831999778747559,fontStyle:"normal",fontWeight:"400",fontFamily:"serif",fontColor:"#444",isChinese:!0},{value:"\u672C",fontSize:16,width:16,height:15.37600040435791,fontStyle:"normal",fontWeight:"400",fontFamily:"serif",fontColor:"#444",isChinese:!0},{value:"\u6E32",fontSize:16,width:16,height:14.592000007629395,fontStyle:"normal",fontWeight:"400",fontFamily:"serif",fontColor:"#444",isChinese:!0},{value:"\u67D3",fontSize:16,width:16,height:15.35999870300293,fontStyle:"normal",fontWeight:"400",fontFamily:"serif",fontColor:"#444",isChinese:!0},{value:`
`,fontSize:16,width:0,height:0,fontStyle:"normal",fontWeight:"400",fontFamily:"serif",fontColor:"#444",isChinese:!1},{value:"c",fontSize:16,width:8.751998901367188,height:8.720000267028809,fontStyle:"normal",fontWeight:"400",fontFamily:"serif",fontColor:"#f60000",isChinese:!1},{value:"a",fontSize:16,width:8.943984985351562,height:8.720000267028809,fontStyle:"normal",fontWeight:"400",fontFamily:"serif",fontColor:"#f60000",isChinese:!1},{value:"n",fontSize:16,width:8.943984985351562,height:8.496000289916992,fontStyle:"normal",fontWeight:"400",fontFamily:"serif",fontColor:"#f60000",isChinese:!1},{value:"a",fontSize:16,width:8.943984985351562,height:8.720000267028809,fontStyle:"normal",fontWeight:"400",fontFamily:"serif",fontColor:"#f60000",isChinese:!1},{value:"s",fontSize:16,width:8.079986572265625,height:8.720000267028809,fontStyle:"normal",fontWeight:"400",fontFamily:"serif",fontColor:"#f60000",isChinese:!1},{value:"\u5BCC",fontSize:16,width:16,height:15.26400089263916,fontStyle:"normal",fontWeight:"400",fontFamily:"serif",fontColor:"#444",isChinese:!0},{value:"\u6587",fontSize:16,width:16,height:14.831999778747559,fontStyle:"normal",fontWeight:"400",fontFamily:"serif",fontColor:"#444",isChinese:!0},{value:"\u672C",fontSize:16,width:16,height:15.37600040435791,fontStyle:"normal",fontWeight:"400",fontFamily:"serif",fontColor:"#444",isChinese:!0},{value:"\u6E32",fontSize:16,width:16,height:14.592000007629395,fontStyle:"normal",fontWeight:"400",fontFamily:"serif",fontColor:"#444",isChinese:!0},{value:"\u67D3",fontSize:16,width:16,height:15.35999870300293,fontStyle:"normal",fontWeight:"400",fontFamily:"serif",fontColor:"#444",isChinese:!0}];class F{constructor(){h(this,"_content");h(this,"_renderContent");h(this,"_config");this._content=v,this._config={fontSize:16,fontWeight:"400",fontFamily:"serif",fontColor:"#444",fontStyle:"normal",wordSpace:1,lineHeight:1.2,pageMargin:10,pageWidth:200},this._renderContent=[]}getContent(){return this._content}getRenderContent(){const t=this._config.pageWidth-this._config.pageMargin*2,i=[];let e={height:0,texts:[]},o=0;return this._content.forEach(n=>{n.value===`
`?(e.height===0&&(e.height=n.fontSize),i.push(e),e={height:0,texts:[n]},o=0):o+n.width<t?(e.texts.push(n),e.height<n.fontSize&&(e.height=n.fontSize),o=o+n.width+this._config.wordSpace):(i.push(e),e={height:0,texts:[n]},o=n.width+this._config.wordSpace)}),e.texts.length>0&&i.push(e),this._renderContent=i,i}getRenderSelect(t,i,e,o,n){if(o>=n[1]&&o<=n[3]){let s=0,r=0;if(n[1]===n[3]?(s=n[0],r=n[2]):n[1]===o?(s=n[0],r=e.texts.length):o<n[3]?(s=0,r=e.texts.length):o===n[3]&&(s=0,r=n[2]),s===r)return;s>0&&(t+=e.texts.filter(l=>l.value!==`
`).slice(0,s).map(l=>l.width).reduce((l,c)=>l+c+this._config.wordSpace));const f=e.texts.filter(l=>l.value!==`
`).slice(s,r).map(l=>l.width).reduce((l,c)=>l+c+this._config.wordSpace);return{x:t,y:i,width:f+this._config.wordSpace,height:e.height*this._config.lineHeight}}}getStashRenderContent(){return this._renderContent}setPageWidth(t){this._config.pageWidth=t}getLength(){return this._content.length}getConfg(){return this._config}addContent(t,i){this._content.splice(i,0,t)}deleteContent(t){return t>=this._content.length||t===-1?!1:(this._content.splice(t,1),!0)}}window.onload=()=>{const a=document.querySelector("#editor"),t=new F,i=new x(a,t);console.log("\u5B9E\u4F8B",i)};
