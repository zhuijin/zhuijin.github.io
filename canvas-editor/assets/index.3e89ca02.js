var E=Object.defineProperty;var D=(l,t,e)=>t in l?E(l,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):l[t]=e;var f=(l,t,e)=>(D(l,typeof t!="symbol"?t+"":t,e),e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const s of o.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&n(s)}).observe(document,{childList:!0,subtree:!0});function e(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerpolicy&&(o.referrerPolicy=i.referrerpolicy),i.crossorigin==="use-credentials"?o.credentials="include":i.crossorigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function n(i){if(i.ep)return;i.ep=!0;const o=e(i);fetch(i.href,o)}})();const _=4;class W{constructor(t,e,n){f(this,"_container");f(this,"_cursor");f(this,"_textarea");f(this,"_data");f(this,"_height");f(this,"_top");f(this,"_left");f(this,"_renderDataPosition");f(this,"_dataPosition");this._container=t,this._cursor=null,this._data=e,this._textarea=n;const i=this._data.getConfg();this._height=i.lineHeight*i.fontSize+_,this._top=i.pageMargin-_/2+1,this._left=i.pageMargin-i.wordSpace/2-.5,this._dataPosition=-1,this._renderDataPosition=[-1,0],this._createCursor(),this.updateCursor()}_createCursor(){const t=document.createElement("div");t.style.width="1px",t.style.position="absolute",t.style.background="black",t.style.display="none",t.style.userSelect="none",t.classList.add("editor-cursor"),this._cursor=t,this._container.append(t)}hideCursor(){this._cursor.style.display="none"}showCursor(){this._cursor.style.display="block"}updateCursor(){if(!this._cursor)return;this._data.getRenderContent().forEach((e,n)=>{(n===this._renderDataPosition[0]||n===0&&this._renderDataPosition[0]===-1)&&this.setCursorHeight(e.height)}),this._cursor.style.left=`${this._left}px`,this._cursor.style.top=`${this._top}px`,this._cursor.style.height=`${this._height}px`,this._textarea.setTextareaPosition(this._left,this._top+this._height/2)}getCursorPosition(t,e,n){const{top:i,textY:o}=this._getTextYCursorPosition(n,e),s=n[o],r=s.texts,a=this._data.getAlignOffsetX(s),{left:h,textX:u}=this._getTextXCursorPosition(r,t-a);return this._renderDataPosition=[o,u],{left:h+a,textX:u,top:i,textY:o}}setCursorPosition(t,e){const n=this._data.getRenderContent(),{left:i,textX:o,top:s,textY:r}=this.getCursorPosition(t,e,n);this._top=s,this._left=i;let a=0;n.forEach((h,u)=>{u<r&&(a+=h.texts.length)}),this.setDataPosition(a+o)}setCursorPositionByData(){const{top:t,left:e}=this._getLineCursorPositionByData();this._left=e,this._top=t}_getLineCursorPositionByData(){const t=this._data.getConfg();let e=t.pageMargin-_/2+1,n=t.pageMargin-t.wordSpace/2-.5;const i=this._data.getRenderContent();if(i.length>0){for(const[r,a]of i.entries()){if(this._renderDataPosition[0]===r)break;e=e+a.height*t.lineHeight}const o=i[this._renderDataPosition[0]];let s=0;if(o){for(const[r,a]of o.texts.entries()){if(this._renderDataPosition[1]<r)break;n=n+a.width+t.wordSpace}s=this._data.getAlignOffsetX(o)}n=n+s}return{top:e,left:n}}_getTextYCursorPosition(t,e){const n=this._data.getConfg();let i=n.pageMargin-_/2+1,o=0;const s=t.length;for(const[r,a]of t.entries()){if(e<i+a.height*n.lineHeight)break;r+1<s&&(o++,i=i+a.height*n.lineHeight)}return{top:i,textY:o}}_getTextXCursorPosition(t,e){const n=this._data.getConfg();let i=n.pageMargin-n.wordSpace/2-.5,o=-1;for(const s of t){if(e<i+s.width/2)break;o++,i=i+s.width+n.wordSpace}return o===t.length-1&&o--,{left:i,textX:o}}setCursorHeight(t){const e=this._data.getConfg();this._height=t*e.lineHeight+_}setRenderDataPosition(){if(this._dataPosition===-1)this._renderDataPosition=[0,-1];else{const t=this._data.getRenderContent();let e=0;for(const[n,i]of t.entries())if(this._dataPosition<e+i.texts.length-1){this._renderDataPosition=[n,this._dataPosition-e];break}else e=e+i.texts.length}}getRenderDataPosition(){return this._renderDataPosition}setDataPosition(t){t<-1||t>=this._data.getLength()-1||(this._dataPosition=t,this.setRenderDataPosition())}getDataPosition(){return this._dataPosition}}const k=new RegExp("[\u4E00-\u9FA5]+"),L=new RegExp("[\u300A\u300B~\uFF01@#\uFFE5\u2026\u2026&*\uFF08\uFF09\u2014\u2014|{}\u3010\u3011\u2018\uFF1B\uFF1A\u201D\u201C'\u3002\uFF0C\u3001\uFF1F]"),T=l=>k.test(l)||L.test(l),m=l=>l&&JSON.parse(JSON.stringify(l)),B=[{label:"Arial",value:"Arial"},{label:"\u5FAE\u8F6F\u96C5\u9ED1",value:"Microsoft YaHei"},{label:"\u5B8B\u4F53",value:"SimSun"},{label:"\u9ED1\u4F53",value:"SimHei"},{label:"\u6977\u4F53",value:"KaiTi"},{label:"\u65B0\u5B8B\u4F53",value:"NSimSun"},{label:"\u4EFF\u5B8B",value:"FangSong"},{label:"\u82F9\u65B9",value:"PingFang SC"},{label:"\u534E\u6587\u9ED1\u4F53",value:"STHeiti"},{label:"\u534E\u6587\u6977\u4F53",value:"STKaiti"},{label:"\u534E\u6587\u5B8B\u4F53",value:"STSong"},{label:"\u534E\u6587\u4EFF\u5B8B",value:"STFangSong"},{label:"\u534E\u6587\u4E2D\u5B8B",value:"STZhongSong"},{label:"\u534E\u6587\u7425\u73C0",value:"STHupo"},{label:"\u534E\u6587\u65B0\u9B4F",value:"STXinwei"},{label:"\u534E\u6587\u96B6\u4E66",value:"STLiti"},{label:"\u534E\u6587\u884C\u6977",value:"STXingkai"},{label:"\u51AC\u9752\u9ED1\u4F53",value:"Hiragino Sans GB"},{label:"\u5170\u4EAD\u9ED1",value:"Lantinghei SC"},{label:"\u504F\u504F\u4F53",value:"Hanzipen SC"},{label:"\u624B\u672D\u4F53",value:"Hannotate SC"},{label:"\u5B8B\u4F53",value:"Songti SC"},{label:"\u5A03\u5A03\u4F53",value:"Wawati SC"},{label:"\u884C\u6977",value:"Xingkai SC"},{label:"\u5706\u4F53",value:"Yuanti SC"},{label:"\u534E\u6587\u7EC6\u9ED1",value:"STXihei"},{label:"\u5E7C\u5706",value:"YouYuan"},{label:"\u96B6\u4E66",value:"LiSu"}],A=l=>{if(typeof l!="string")return!1;const t="Arial";if(l.toLowerCase()===t.toLowerCase())return!0;const e=100,n=100,i=100,o="a",s=document.createElement("canvas"),r=s.getContext("2d");if(!r)return!1;s.width=n,s.height=i,r.textAlign="center",r.fillStyle="black",r.textBaseline="middle";const a=h=>{r.clearRect(0,0,n,i),r.font=`${e}px ${h}, ${t}`,r.fillText(o,n/2,i/2);const u=r.getImageData(0,0,n,i).data;return[].slice.call(u).filter(d=>d!==0)};return a(t).join("")!==a(l).join("")},X=async()=>{var l;if((l=navigator.clipboard)!=null&&l.readText){const t=await navigator.clipboard.readText();return t||console.error(new Error("\u526A\u8D34\u677F\u4E3A\u7A7A\u6216\u8005\u4E0D\u5305\u542B\u6587\u672C")),t}return""},R=[{value:"c",fontSize:16,width:8.751998901367188,height:8.720000267028809,fontStyle:"normal",fontWeight:"normal",fontFamily:"\u6977\u4F53",fontColor:"#f60000",isChinese:!1,underline:!0},{value:"a",fontSize:16,width:8.943984985351562,height:8.720000267028809,fontStyle:"normal",fontWeight:"normal",fontFamily:"\u6977\u4F53",fontColor:"#f60000",isChinese:!1,underline:!0},{value:"n",fontSize:16,width:8.943984985351562,height:8.496000289916992,fontStyle:"normal",fontWeight:"normal",fontFamily:"\u6977\u4F53",fontColor:"#f60000",isChinese:!1,underline:!0},{value:"a",fontSize:56,width:31.303985595703125,height:30.520000457763672,fontStyle:"normal",fontWeight:"normal",fontFamily:"\u6977\u4F53",fontColor:"#f60000",isChinese:!1,underline:!0},{value:"s",fontSize:56,width:28.279998779296875,height:30.520000457763672,fontStyle:"normal",fontWeight:"normal",fontFamily:"\u6977\u4F53",fontColor:"#f60000",isChinese:!1,underline:!0},{value:"\u5BCC",fontSize:56,width:56,height:51.85600280761719,fontStyle:"normal",fontWeight:"normal",fontFamily:"\u6977\u4F53",fontColor:"#444",isChinese:!0,underline:!0},{value:"\u6587",fontSize:56,width:56,height:51.96800231933594,fontStyle:"normal",fontWeight:"normal",fontFamily:"\u6977\u4F53",fontColor:"#444",isChinese:!0,underline:!0},{value:"\u672C",fontSize:56,width:56,height:51.183998107910156,fontStyle:"normal",fontWeight:"normal",fontFamily:"\u6977\u4F53",fontColor:"#444",isChinese:!0,underline:!0},{value:"\u6E32",fontSize:56,width:56,height:51.407997131347656,fontStyle:"normal",fontWeight:"normal",fontFamily:"\u6977\u4F53",fontColor:"#444",isChinese:!0,underline:!0},{value:"\u67D3",fontSize:56,width:56,height:51.183998107910156,fontStyle:"normal",fontWeight:"normal",fontFamily:"\u6977\u4F53",fontColor:"#444",isChinese:!0,underline:!0},{value:"c",fontSize:56,width:30.631988525390625,height:30.520000457763672,fontStyle:"normal",fontWeight:"normal",fontFamily:"\u6977\u4F53",fontColor:"#f60000",isChinese:!1,underline:!0},{value:"a",fontSize:56,width:31.303985595703125,height:30.520000457763672,fontStyle:"normal",fontWeight:"normal",fontFamily:"\u6977\u4F53",fontColor:"#f60000",isChinese:!1,underline:!0},{value:"n",fontSize:56,width:31.303985595703125,height:29.736000061035156,fontStyle:"normal",fontWeight:"normal",fontFamily:"\u6977\u4F53",fontColor:"#f60000",isChinese:!1,underline:!0},{value:"a",fontSize:56,width:31.303985595703125,height:30.520000457763672,fontStyle:"normal",fontWeight:"normal",fontFamily:"\u6977\u4F53",fontColor:"#f60000",isChinese:!1,underline:!0},{value:"s",fontSize:56,width:28.279998779296875,height:30.520000457763672,fontStyle:"normal",fontWeight:"normal",fontFamily:"\u6977\u4F53",fontColor:"#f60000",isChinese:!1,underline:!0},{value:"\u5BCC",fontSize:62,width:62,height:57.41200256347656,fontStyle:"normal",fontWeight:"normal",fontFamily:"\u6977\u4F53",fontColor:"#444",isChinese:!0,underline:!0},{value:"\u6587",fontSize:62,width:62,height:57.53600311279297,fontStyle:"normal",fontWeight:"normal",fontFamily:"\u6977\u4F53",fontColor:"#444",isChinese:!0,underline:!0},{value:"\u672C",fontSize:16,width:16,height:15.37600040435791,fontStyle:"normal",fontWeight:"normal",fontFamily:"\u6977\u4F53",fontColor:"#444",isChinese:!0,underline:!0},{value:"\u6E32",fontSize:16,width:16,height:14.592000007629395,fontStyle:"normal",fontWeight:"normal",fontFamily:"\u6977\u4F53",fontColor:"#444",isChinese:!0,underline:!0},{value:"\u67D3",fontSize:16,width:16,height:15.35999870300293,fontStyle:"normal",fontWeight:"normal",fontFamily:"\u6977\u4F53",fontColor:"#444",isChinese:!0,underline:!0},{value:"c",fontSize:16,width:8.751998901367188,height:8.720000267028809,fontStyle:"normal",fontWeight:"normal",fontFamily:"\u6977\u4F53",fontColor:"#f60000",isChinese:!1,underline:!0},{value:"a",fontSize:16,width:8.943984985351562,height:8.720000267028809,fontStyle:"normal",fontWeight:"normal",fontFamily:"\u6977\u4F53",fontColor:"#f60000",isChinese:!1,underline:!0},{value:"n",fontSize:16,width:8.943984985351562,height:8.496000289916992,fontStyle:"normal",fontWeight:"normal",fontFamily:"\u6977\u4F53",fontColor:"#f60000",isChinese:!1,underline:!0},{value:"a",fontSize:16,width:8.943984985351562,height:8.720000267028809,fontStyle:"normal",fontWeight:"normal",fontFamily:"\u6977\u4F53",fontColor:"#f60000",isChinese:!1,underline:!0},{value:"s",fontSize:16,width:8.079986572265625,height:8.720000267028809,fontStyle:"normal",fontWeight:"normal",fontFamily:"\u6977\u4F53",fontColor:"#f60000",isChinese:!1,underline:!0},{value:"\u5BCC",fontSize:16,width:16,height:15.26400089263916,fontStyle:"normal",fontWeight:"normal",fontFamily:"\u6977\u4F53",fontColor:"#444",isChinese:!0,underline:!0},{value:"\u6587",fontSize:16,width:16,height:14.831999778747559,fontStyle:"normal",fontWeight:"normal",fontFamily:"\u6977\u4F53",fontColor:"#444",isChinese:!0,underline:!0},{value:"\u672C",fontSize:16,width:16,height:15.37600040435791,fontStyle:"normal",fontWeight:"normal",fontFamily:"\u6977\u4F53",fontColor:"#444",isChinese:!0,underline:!0},{value:"\u6E32",fontSize:16,width:16,height:14.592000007629395,fontStyle:"normal",fontWeight:"normal",fontFamily:"\u6977\u4F53",fontColor:"#444",isChinese:!0,underline:!0},{value:"\u67D3",fontSize:16,width:16,height:15.35999870300293,fontStyle:"normal",fontWeight:"normal",fontFamily:"\u6977\u4F53",fontColor:"#444",isChinese:!0,underline:!0},{value:`
`,fontSize:16,width:0,height:0,fontStyle:"normal",fontWeight:"normal",fontFamily:"\u6977\u4F53",fontColor:"#444",isChinese:!1,underline:!0},{value:"c",fontSize:16,width:8.751998901367188,height:8.720000267028809,fontStyle:"normal",fontWeight:"normal",fontFamily:"\u6977\u4F53",fontColor:"#f60000",isChinese:!1},{value:"a",fontSize:16,width:8.943984985351562,height:8.720000267028809,fontStyle:"normal",fontWeight:"normal",fontFamily:"\u6977\u4F53",fontColor:"#f60000",isChinese:!1},{value:"n",fontSize:16,width:8.943984985351562,height:8.496000289916992,fontStyle:"normal",fontWeight:"normal",fontFamily:"\u6977\u4F53",fontColor:"#f60000",isChinese:!1},{value:"a",fontSize:16,width:8.943984985351562,height:8.720000267028809,fontStyle:"normal",fontWeight:"normal",fontFamily:"\u6977\u4F53",fontColor:"#f60000",isChinese:!1},{value:"s",fontSize:16,width:8.079986572265625,height:8.720000267028809,fontStyle:"normal",fontWeight:"normal",fontFamily:"\u6977\u4F53",fontColor:"#f60000",isChinese:!1},{value:"\u5BCC",fontSize:16,width:16,height:15.26400089263916,fontStyle:"normal",fontWeight:"normal",fontFamily:"\u6977\u4F53",fontColor:"#444",isChinese:!0},{value:"\u6587",fontSize:16,width:16,height:14.831999778747559,fontStyle:"normal",fontWeight:"normal",fontFamily:"\u6977\u4F53",fontColor:"#444",isChinese:!0},{value:"\u672C",fontSize:16,width:16,height:15.37600040435791,fontStyle:"normal",fontWeight:"normal",fontFamily:"\u6977\u4F53",fontColor:"#444",isChinese:!0},{value:"\u6E32",fontSize:16,width:16,height:14.592000007629395,fontStyle:"normal",fontWeight:"normal",fontFamily:"\u6977\u4F53",fontColor:"#444",isChinese:!0,strikout:!0},{value:"\u67D3",fontSize:16,width:16,height:15.35999870300293,fontStyle:"normal",fontWeight:"normal",fontFamily:"\u6977\u4F53",fontColor:"#444",isChinese:!0,strikout:!0},{value:`
`,fontSize:16,width:0,height:0,fontStyle:"normal",fontWeight:"normal",fontFamily:"\u6977\u4F53",fontColor:"#444",isChinese:!1}],P={fontSize:16,fontWeight:"normal",fontFamily:"\u6977\u4F53",fontColor:"#444",fontStyle:"normal",wordSpace:1,lineHeight:2,pageMargin:10,pageWidth:200,align:"left"};class M{constructor(t){f(this,"_content");f(this,"_renderContent");f(this,"_config");f(this,"_copyContent");f(this,"_ctx");this._ctx=t,this._content=R,this._config=m(P),this._renderContent=[],this._copyContent=[]}resetConfig(){this._config=m(P)}updateConfig(t){this._config={...this._config,...t}}getContent(){return this._content}getRenderContent(){const t=this._config.pageWidth-this._config.pageMargin*2,e=[];let n={height:0,width:0,texts:[]},i=0;return this._content.forEach(o=>{n.height===0&&(n.height=o.fontSize),o.value===`
`?(n.texts.push(o),e.push(n),n={height:0,width:0,texts:[]},i=0):i+o.width<t?(n.texts.push(o),n.height<o.fontSize&&(n.height=o.fontSize),i=i+o.width+this._config.wordSpace,n.width=i):(e.push(n),n={height:0,width:0,texts:[o]},i=o.width+this._config.wordSpace)}),this._renderContent=e,e}getRenderSelect(t,e,n,i,o){if(i>=o[1]&&i<=o[3]){let s=0,r=0;if(o[1]===o[3]?(s=o[0],r=o[2]):o[1]===i?(s=o[0],r=n.texts.length):i<o[3]?(s=0,r=n.texts.length):i===o[3]&&(s=0,r=o[2]),s===r)return;s>0&&(t+=n.texts.slice(0,s).map(u=>u.width).reduce((u,d)=>u+d+this._config.wordSpace));const a=n.texts.slice(s,r).map(u=>u.width).reduce((u,d)=>u+d+this._config.wordSpace),h=this.getAlignOffsetX(n);return{x:t+h,y:e,width:a+this._config.wordSpace,height:n.height*this._config.lineHeight}}}getAlignOffsetX(t){const e=this._config.align||"left";return{left:0,center:(this._config.pageWidth-this._config.pageMargin*2-t.width)/2,right:this._config.pageWidth-this._config.pageMargin*2-t.width}[e]}getStashRenderContent(){return this._renderContent}setPageWidth(t){this._config.pageWidth=t}getLength(){return this._content.length}getConfg(){return this._config}addContent(t,e){this._content.splice(e,0,t)}deleteContent(t){return t>=this._content.length||t===-1?!1:(this._content.splice(t,1),!0)}getSelectArea(t){const e=this.getRenderContent();let n=0,i=0,o=!1,s=!1;return e.forEach((r,a)=>{t[1]===a?(n+=t[0],o=!0):o||(n+=r.texts.length),t[3]===a?(i+=t[2],s=!0):s||(i+=r.texts.length)}),{startX:n,endX:i}}getFontSize(t){this._ctx.font=`${t.fontStyle} ${t.fontWeight} ${t.fontSize}px ${t.fontFamily}`;const e=this._ctx.measureText(t.value),n=e.width,i=e.actualBoundingBoxAscent+e.actualBoundingBoxDescent;return{width:n,height:i}}deleteSelectContent(t){const{startX:e,endX:n}=this.getSelectArea(t);return this._content.splice(e,n-e),e}copySelectContent(t){const{startX:e,endX:n}=this.getSelectArea(t);return this._copyContent=this._content.slice(e,n),this._copyContent}async pasteContent(t,e){if(this._copyContent.length===0){const i=await X();if(i){const o=this.getConfg(),s={value:"",fontSize:o.fontSize,fontFamily:o.fontFamily,fontWeight:o.fontWeight,fontColor:o.fontColor,fontStyle:o.fontStyle,width:o.fontSize,height:o.fontSize,underline:!!o.underline,strikout:!!o.strikout,isChinese:!1};i.split("").forEach(r=>{s.value=r;const{width:a,height:h}=this.getFontSize(s);s.width=a,s.height=h,s.isChinese=T(r),this._copyContent.push(m(s))})}else return!1}let n=0;if(t){const i=this.deleteSelectContent(t);this._content.splice(i,0,...this._copyContent),n=i+this._copyContent.length}else this._content.splice(e+1,0,...this._copyContent),n=e+1+this._copyContent.length;return this._copyContent=[],n}}var g=(l=>(l.ENTER="Enter",l.BACKSPACE="Backspace",l.LEFT="ArrowLeft",l.TOP="ArrowUp",l.RIGHT="ArrowRight",l.BOTTOM="ArrowDown",l.S="s",l.C="c",l.X="x",l.V="v",l))(g||{});class H{constructor(){f(this,"onSelectChange");f(this,"onCursorChange");this.onSelectChange=null,this.onCursorChange=null}}class Y{constructor(t){f(this,"_textarea");f(this,"_container");this._container=t,this._textarea=this._createTextarea()}_createTextarea(){const t=document.createElement("textarea");return t.style.position="absolute",t.style.zIndex="-100",t.style.background="transparent",t.style.border="none",t.style.resize="none",t.style.outline="none",t.style.color="transparent",this._container.append(t),t}setTextareaPosition(t,e){this._textarea.style.left=t+"px",this._textarea.style.top=e+"px"}getTextareaElement(){return this._textarea}}class O{constructor(t){f(this,"listener");f(this,"_container");f(this,"_canvas");f(this,"_ctx");f(this,"_textarea");f(this,"_data");f(this,"_cursor");f(this,"_selectArea");f(this,"_click");this.listener=new H,this._container=t,this._selectArea=null,this._click=null;const{canvas:e,ctx:n}=this._createCanvas();this._canvas=e,this._ctx=n,this._data=new M(this._ctx),this._data.setPageWidth(this._container.clientWidth);const i=new Y(this._container);this._textarea=i.getTextareaElement(),this._cursor=new W(this._container,this._data,i),this._bindEvents(),this._renderRichText()}get config(){return this._data.getConfg()}get isSelectContent(){return this._selectArea&&(this._selectArea[0]!==this._selectArea[2]||this._selectArea[1]!==this._selectArea[3])}_forSelectTexts(t){if(this._selectArea){const e=this._data.getRenderContent(),[n,i,o,s]=this._selectArea;e.forEach((r,a)=>{a>=i&&a<=s&&r.texts.forEach((h,u)=>{(i===s&&n<=u&&u<o||i!==s&&a===i&&n<=u||i!==s&&a!==i&&a!==s||i!==s&&a===s&&u<=o)&&t&&t(h)})}),this._renderRichText()}}hideCursor(){this._cursor.hideCursor()}setFontFamily(t){this._data.updateConfig({fontFamily:t}),this._forSelectTexts(e=>{e.fontFamily=t;const{width:n,height:i}=this._data.getFontSize(e);e.width=n,e.height=i})}setFontColor(t){this._forSelectTexts(e=>{e.fontColor=t})}setFontSize(t){this._forSelectTexts(e=>{t==="large"?e.fontSize+=2:e.fontSize-=2;const{width:n,height:i}=this._data.getFontSize(e);e.width=n,e.height=i})}setFontBold(t){this._forSelectTexts(e=>{e.fontWeight=t?"bold":"normal";const{width:n,height:i}=this._data.getFontSize(e);e.width=n,e.height=i})}setFontItalic(t){this._forSelectTexts(e=>{e.fontStyle=t?"italic":"normal";const{width:n,height:i}=this._data.getFontSize(e);e.width=n,e.height=i})}setFontUnderLine(t){this._forSelectTexts(e=>{e.underline=t})}setFontStrikeout(t){this._forSelectTexts(e=>{e.strikout=t})}setAlign(t){this._data.updateConfig({align:t}),this._cursor.setCursorPositionByData(),this._cursor.updateCursor(),this._renderRichText()}_createCanvas(){const t=this._container.clientWidth,e=this._container.clientHeight,n=document.createElement("canvas");n.tabIndex=0,n.style.outline="none",n.style.background="#fff";const i=window.devicePixelRatio;n.style.width=t+"px",n.style.height=e+"px",n.width=t*i,n.height=e*i;const o=n.getContext("2d");return o.scale(i,i),this._container.append(n),{canvas:n,ctx:o}}_bindEvents(){this._canvas.addEventListener("mousedown",this._onMouseDown.bind(this)),this._canvas.addEventListener("mousemove",this._onMouseMove.bind(this)),this._canvas.addEventListener("mouseup",this._onMouseUp.bind(this)),this._canvas.addEventListener("mouseout",this._onMouseOut.bind(this)),this._canvas.addEventListener("keydown",t=>this._onKeydown(t)),this._textarea.addEventListener("input",t=>this._onInput(t)),this._textarea.addEventListener("compositionend",t=>this._onCompEnd(t)),this._textarea.addEventListener("keydown",t=>this._onKeydown(t))}_onMouseDown(t){const e=this._data.getRenderContent(),{textX:n,textY:i}=this._cursor.getCursorPosition(t.offsetX,t.offsetY,e);this._click={x:t.offsetX,y:t.offsetY,textX:n+1,textY:i},this._cursor.hideCursor(),this._selectArea=null,this._renderRichText()}_onMouseMove(t){if(t.preventDefault(),this._click){const e=this._data.getRenderContent(),{textX:n,textY:i}=this._cursor.getCursorPosition(t.offsetX,t.offsetY,e);let o=this._click.textX,s=this._click.textY,r=n+1,a=i;a<s?(r=this._click.textX,a=this._click.textY,o=n+1,s=i):a===s&&o>r&&(r=this._click.textX,o=n+1),this._selectArea=[o,s,r,a],this._renderRichText()}}_onMouseUp(t){t.preventDefault(),this.isSelectContent?(this._dealCurrentSelectStyle(),setTimeout(()=>{this._canvas.focus()},100)):this._click&&(this._focus(t.offsetX,t.offsetY),this._selectArea=null),this._click=null}_onMouseOut(t){t.preventDefault(),this._click=null}_dealCurrentSelectStyle(){const t=this.config,e={fontWeight:"bold",fontSize:t.fontSize,fontColor:t.fontColor,fontFamily:t.fontFamily,fontStyle:"italic",underline:!0,strikout:!0};this._forSelectTexts(n=>{n.fontWeight==="normal"&&(e.fontWeight="normal"),e.fontSize&&n.fontSize!==e.fontSize&&delete e.fontSize,e.fontColor&&n.fontColor!==e.fontColor&&delete e.fontColor,e.fontFamily&&n.fontFamily!==e.fontFamily&&delete e.fontFamily,e.fontStyle&&n.fontStyle!==e.fontStyle&&delete e.fontStyle,e.underline&&!n.underline&&delete e.underline,e.strikout&&!n.strikout&&delete e.strikout}),this.listener.onSelectChange&&this.listener.onSelectChange(e)}_focus(t,e){this._cursor.setCursorPosition(t,e),this._cursor.updateCursor(),this._cursor.showCursor(),this._updateFontStyleByCursorFont(),setTimeout(()=>{this._textarea.focus()},100)}_updateFontStyleByCursorFont(){const t=this._cursor.getDataPosition(),e=this._data.getContent(),n=t===-1?this._data.getConfg():e[t],i={fontSize:n.fontSize,fontColor:n.fontColor,fontFamily:n.fontFamily,fontStyle:n.fontStyle,fontWeight:n.fontWeight,underline:!!n.underline,strikout:!!n.strikout};this._data.updateConfig(i),this.listener.onCursorChange&&this.listener.onCursorChange(i)}_onInput(t){t.inputType==="insertText"&&t.data&&this._inputText(t.data)}_onCompEnd(t){t.data&&t.data.split("").forEach(n=>{this._inputText(n)})}_onKeydown(t){switch(t.key){case g.LEFT:{t.preventDefault();const e=this._cursor.getDataPosition();this._cursor.setDataPosition(e-1),this._cursor.setCursorPositionByData(),this._cursor.updateCursor(),this._updateFontStyleByCursorFont();break}case g.RIGHT:{t.preventDefault();const e=this._cursor.getDataPosition();this._cursor.setDataPosition(e+1),this._cursor.setCursorPositionByData(),this._cursor.updateCursor(),this._updateFontStyleByCursorFont();break}case g.TOP:{t.preventDefault();const e=this._cursor.getDataPosition(),n=this._cursor.getRenderDataPosition();if(n[0]>0){const i=this._data.getStashRenderContent(),o=i[n[0]];let s=this._data.getAlignOffsetX(o);for(const[u,d]of o.texts.entries())u<=n[1]&&(s+=d.width);const r=i[n[0]-1];let a=-1,h=this._data.getAlignOffsetX(r);for(const u of r.texts)if(h<=s)a++,h+=u.width;else break;a===-1&&(a=0),this._cursor.setDataPosition(e-(n[1]+1+r.texts.length-a)),this._cursor.setCursorPositionByData(),this._cursor.updateCursor(),this._updateFontStyleByCursorFont()}break}case g.BOTTOM:{t.preventDefault();const e=this._cursor.getDataPosition(),n=this._cursor.getRenderDataPosition(),i=this._data.getStashRenderContent();if(n[0]<i.length-1){const o=i[n[0]];let s=this._data.getAlignOffsetX(o);for(const[u,d]of o.texts.entries())u<=n[1]&&(s+=d.width);const r=i[n[0]+1];let a=-1,h=this._data.getAlignOffsetX(r);for(const u of r.texts)if(h<=s)a++,h+=u.width;else break;a===-1&&(a=0),this._cursor.setDataPosition(e+(o.texts.length-(n[1]+1)+a)),this._cursor.setCursorPositionByData(),this._cursor.updateCursor(),this._updateFontStyleByCursorFont()}break}case g.ENTER:{t.preventDefault();const e=this._data.getConfg(),n={value:`
`,fontSize:e.fontSize,fontFamily:e.fontFamily,fontWeight:e.fontWeight,fontColor:e.fontColor,fontStyle:e.fontStyle,width:0,height:0,isChinese:!1},i=this._cursor.getDataPosition();this._data.addContent(n,i+1),this._cursor.setDataPosition(i+1),this._cursor.setCursorPositionByData(),this._cursor.updateCursor(),this._renderRichText();break}case g.BACKSPACE:{t.preventDefault(),this._deleteText();break}case g.S:{(t.ctrlKey||t.metaKey)&&(t.preventDefault(),console.log(JSON.stringify(this._data.getContent())));break}case g.C:{(t.ctrlKey||t.metaKey)&&this._copyText();break}case g.X:{(t.ctrlKey||t.metaKey)&&this._cutText();break}case g.V:{(t.ctrlKey||t.metaKey)&&this._pasteText();break}}}_copyText(){this._selectArea&&this._data.copySelectContent(this._selectArea),setTimeout(()=>{this._textarea.focus()},100)}_cutText(){this._selectArea&&(this._data.copySelectContent(this._selectArea),this._deleteText()),setTimeout(()=>{this._textarea.focus()},100)}async _pasteText(){const t=this._cursor.getDataPosition(),e=await this._data.pasteContent(this._selectArea,t);typeof e=="number"&&(this._selectArea=null,this._renderRichText(),this._cursor.setDataPosition(e-1),this._cursor.setCursorPositionByData(),this._cursor.updateCursor(),this._cursor.showCursor(),this._updateFontStyleByCursorFont()),setTimeout(()=>{this._textarea.focus()},100)}_deleteText(t=0){if(this._selectArea){const e=this._data.deleteSelectContent(this._selectArea);this._selectArea=null,this._renderRichText(),this._cursor.setDataPosition(e-1),this._cursor.setCursorPositionByData(),this._cursor.updateCursor(),this._cursor.showCursor(),this._updateFontStyleByCursorFont(),setTimeout(()=>{this._textarea.focus()},100)}else{const e=this._cursor.getDataPosition();this._data.deleteContent(e+t)&&(t===0&&(this._cursor.setDataPosition(e-1),this._cursor.setCursorPositionByData(),this._cursor.updateCursor()),this._renderRichText())}}_inputText(t){const e=this.config,n={value:t,fontSize:e.fontSize,fontFamily:e.fontFamily,fontWeight:e.fontWeight,fontColor:e.fontColor,fontStyle:e.fontStyle,width:e.fontSize,height:e.fontSize,underline:!!e.underline,strikout:!!e.strikout,isChinese:T(t)},{width:i,height:o}=this._data.getFontSize(n);n.width=i,n.height=o;const s=this._cursor.getDataPosition();this._data.addContent(n,s+1),this._cursor.setDataPosition(s+1),this._cursor.setCursorPositionByData(),this._cursor.updateCursor(),this._renderRichText(),this._textarea.value=""}_clear(){this._ctx.clearRect(0,0,this._canvas.width,this._canvas.height)}_renderRange({x:t,y:e,width:n,height:i}){this._ctx.save(),this._ctx.globalAlpha=.6,this._ctx.fillStyle="#AECBFA",this._ctx.fillRect(t,e,n,i),this._ctx.restore()}_renderRichText(){this._clear();const t=this._data.getRenderContent(),e=this._data.getConfg();let n=e.pageMargin,i=e.pageMargin;t.forEach((o,s)=>{if(this._selectArea){const h=this._data.getRenderSelect(n,i,o,s,this._selectArea);h&&this._renderRange(h)}const r=o.height*e.lineHeight,a=this._data.getAlignOffsetX(o);o.texts.forEach(h=>{h.value!==`
`&&(h.underline&&this._drawUnderLine(h,n+a,i,o.height),h.strikout&&this._drawStrikout(h,n+a,i,o.height),this._fillText(h,n+a,i,o.height),n=n+h.width+e.wordSpace)}),n=e.pageMargin,i=i+r})}_drawStrikout(t,e,n,i){const o=this._data.getConfg(),s=i+i*(o.lineHeight-1)/2,r=(i-t.fontSize)*.1,a=n+s+2-t.fontSize/2-r;this._ctx.save(),this._ctx.beginPath(),this._ctx.lineWidth=t.fontSize/10,this._ctx.strokeStyle=t.fontColor;const h=Math.sign(this._ctx.lineWidth-2)*.2;this._ctx.moveTo(e-o.wordSpace/2-h,a),this._ctx.lineTo(e+t.width+o.wordSpace/2+h,a),this._ctx.stroke(),this._ctx.restore()}_drawUnderLine(t,e,n,i){const o=this._data.getConfg(),s=i+i*(o.lineHeight-1)/2,r=n+s+2;this._ctx.save(),this._ctx.beginPath(),this._ctx.lineWidth=Math.ceil(i/20),this._ctx.strokeStyle=t.fontColor;const a=Math.sign(this._ctx.lineWidth-2)*.2;this._ctx.moveTo(e-o.wordSpace/2-a,r),this._ctx.lineTo(e+t.width+o.wordSpace/2+a,r),this._ctx.stroke(),this._ctx.restore()}_fillText(t,e,n,i){this._ctx.save(),this._ctx.textBaseline="bottom";const o=this._data.getConfg();this._ctx.fillStyle=t.fontColor,this._ctx.font=`${t.fontStyle} ${t.fontWeight} ${t.fontSize}px ${t.fontFamily}`;const s=(i-t.fontSize)*.1,r=i+i*(o.lineHeight-1)/2-s;this._ctx.fillText(t.value,e,n+r,t.fontSize),this._ctx.restore()}}window.onload=()=>{const l=document.querySelector("#editor"),t=new O(l);console.log("\u5B9E\u4F8B",t),document.addEventListener("mousedown",c=>{c.composedPath().includes(l)||t.hideCursor()});let e=!1,n=!1,i=!1,o=!1;const s=document.querySelector(".tool-btn-bold"),r=document.querySelector(".tool-btn-italic"),a=document.querySelector(".tool-btn-underline"),h=document.querySelector(".tool-btn-strikeout"),u=document.getElementsByClassName("tool-btn-align"),d=document.querySelector("#fontFamilySelect"),S=B.filter(c=>A(c.value));let F="";S.forEach(c=>{F+=`<option value="${c.value}">${c.label}</option>`}),d&&(d.innerHTML=F,d.value=S[0].value,d.addEventListener("change",c=>{t.setFontFamily(c.target.value)}),t.setFontFamily(S[0].value));const p=c=>{e=c.fontWeight==="bold",n=c.fontStyle==="italic",i=!!c.underline,o=!!c.strikout,w(),v(),x(),z(),d&&(d.value=c.fontFamily||"")};t.listener.onSelectChange=p,t.listener.onCursorChange=p;const w=()=>{e?s==null||s.classList.add("active"):s==null||s.classList.remove("active")},v=()=>{n?r==null||r.classList.add("active"):r==null||r.classList.remove("active")},x=()=>{i?a==null||a.classList.add("active"):a==null||a.classList.remove("active")},z=()=>{o?h==null||h.classList.add("active"):h==null||h.classList.remove("active")},b=c=>{for(let C=0;C<u.length;C++){const y=u[C];c===y.getAttribute("data-align")?y.classList.add("active"):y.classList.remove("active")}};window.setFontColor=c=>{t.setFontColor(c.target.value)},window.setAddFontSize=()=>{t.setFontSize("large")},window.setReduceFontSize=()=>{t.setFontSize("small")},window.setFontBold=()=>{t.isSelectContent&&(e=!e,t.setFontBold(e),w())},window.setFontItalic=()=>{t.isSelectContent&&(n=!n,t.setFontItalic(n),v())},window.setFontUnderLine=()=>{t.isSelectContent&&(i=!i,t.setFontUnderLine(i),x())},window.setFontStrikeout=()=>{t.isSelectContent&&(o=!o,t.setFontStrikeout(o),z())},window.setAlign=c=>{b(c),t.setAlign(c)}};
